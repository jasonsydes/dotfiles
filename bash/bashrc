# bashrc is for non-interactive shells

# shortcut to this dotfiles path is $DOTFILES
export DOTFILES="$HOME/.dotfiles"

# Let's set infinite history and PROMPT_COMMAND immediately
# (perhaps this will stop the endemic history truncation)
# 251121
source $DOTFILES/bash/history_and_prompt_command

# /etc/profile workaround - MUST BE (NEARLY) THE FIRST LINE IN THIS FILE!
if [ -f $DOTFILES/etc_profile_workaround ]; then
  source $DOTFILES/etc_profile_workaround
fi

# Looks like Talapas /etc/profile modifies HIST env vars, source
# our version again here. 
# (perhaps this will stop the endemic history truncation)
# 251121
source $DOTFILES/bash/history_and_prompt_command

# Never put anything in your bashrc that you don't understand.
# Never put anything in your bashrc that you don't understand.
# Never put anything in your bashrc that you don't understand.

# Source the non-interactive file
source $DOTFILES/all/main-non-interactive

# Load bash settings.
source $DOTFILES/bash/settings

# Load source files.
for f in $DOTFILES/*/source; do source "$f"; done

# THE LAST ITEMS BELOW.
#
# Miniconda 3 - This should be the LAST item in your bash_proile.
source $DOTFILES/conda/setup_bash
# Nix
source $DOTFILES/nix/setup_bash

# Lando
# export PATH="/home/sydes/.lando/bin:$PATH" #landopath
export PATH="$HOME/.lando/bin:$PATH" #landopath

# â”€â”€ Prompt, bash-preexec, and atuin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
# LOAD ORDER MATTERS. These must load in this exact sequence:
#
#   1. starship        â€” Sets up PROMPT_COMMAND to regenerate PS1 each prompt.
#   2. bash-preexec    â€” Wraps PROMPT_COMMAND and provides precmd_functions
#                        and preexec_functions arrays. Multiple tools can
#                        register hooks without stomping on each other.
#   3. atuin           â€” Hooks into bash-preexec's arrays for history search.
#   4. ghostty shell   â€” Loaded LATER, via terminal/ghostty/interactive
#      integration       (bash_profile â†’ main-interactive â†’ ghostty/interactive).
#                        Hooks into bash-preexec's precmd_functions for OSC 133
#                        prompt marking. Only activates inside tmux.
#
# If bash-preexec loads BEFORE starship, they collide (starship prompt
# breaks). Starship must set up PROMPT_COMMAND first, then bash-preexec
# wraps around it. (Discovered 251102.)
#
# What is bash-preexec?
# Bash natively only has PROMPT_COMMAND (runs before each prompt). It has
# no hook for "right before a command executes." bash-preexec adds two
# capabilities:
#   - precmd_functions[]  â€” array of functions to run before each prompt
#   - preexec_functions[] â€” array of functions to run before each command
# It works by hijacking PROMPT_COMMAND and the DEBUG trap. Tools like
# atuin, starship, and Ghostty's shell integration all register hooks
# here so they coexist without overwriting each other.
#
# After bashrc finishes, bash_profile sources main-interactive, which
# loads terminal/ghostty/interactive â€” that file sources Ghostty's shell
# integration inside tmux, hooking into the same bash-preexec arrays.

# 1. Starship prompt.
# Yes, inside bashrc (non-interactive), not bash_profile (interactive).
# For whatever reason, 'sudo bash' won't load bash_profile, only bashrc.
# But putting the prompt here in bashrc *does* work. ðŸ¤·
# And, noted, putting it here doesn't seem to interfere with scp.
eval "$(starship init bash)"

# 2. bash-preexec (must be after starship, before atuin).
[[ -f ~/.bash-preexec.sh ]] && source ~/.bash-preexec.sh

# 3. Atuin (must be after bash-preexec).
source "$HOME/.atuin/bin/env"
eval "$(atuin init bash --disable-up-arrow)"
