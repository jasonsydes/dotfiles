# tmux.260205-NEW.conf
# Fresh tmux config for Ghostty terminal with catppuccin v2
#
# Test with: tmux -L test -f <path-to-this-file> new-session


# ── Terminal & Ghostty ──────────────────────────────────────────────

# tmux advertises tmux-256color to programs inside it.
# xterm-ghostty is the *outer* terminal — we tell tmux its capabilities
# via terminal-features rather than setting it as default-terminal.
set -g default-terminal "tmux-256color"

# Tell tmux that xterm-ghostty supports true color and extended keys.
# Note: uses -s (not -as) to avoid duplicates when re-sourcing config.
# The defaults (xterm*:clipboard:ccolour:cstyle:focus:title, etc.) are
# built-in to tmux and don't need to be in this list.
set -s terminal-features 'xterm-ghostty:RGB:extkeys'

# Enable extended keys (kitty keyboard protocol / CSI u)
set -s extended-keys on
set -s extended-keys-format csi-u

# Allow escape sequences (e.g. OSC 133 for shell integration) to pass
# through tmux to the outer terminal (Ghostty).
set -g allow-passthrough on


# ── SSH Environment Propagation ─────────────────────────────────────

# Ghostty's ssh-env sends these to remote hosts. tmux doesn't include
# them in update-environment by default, so add them so new panes/
# windows pick them up when reattaching from a different terminal.
# Reset to defaults + Ghostty vars (avoids duplicates on re-source)
set -g update-environment "DISPLAY KRB5CCNAME SSH_ASKPASS SSH_AUTH_SOCK SSH_AGENT_PID SSH_CONNECTION WINDOWID XAUTHORITY TERM_PROGRAM TERM_PROGRAM_VERSION COLORTERM"


# ── Core Settings ───────────────────────────────────────────────────

set -g prefix C-a                # Ctrl-A prefix (not Ctrl-B)
unbind C-b                       # Free up default prefix
bind C-a send-prefix             # Send Ctrl-A to apps with prefix prefix

set -g base-index 1              # Windows start at 1
setw -g pane-base-index 1        # Panes start at 1
set -g renumber-windows on       # Renumber when a window is closed
set -g escape-time 0             # No delay after escape key
set -g history-limit 1000000     # Generous scrollback
set -g set-clipboard on          # Use system clipboard (OSC 52)
set -g status-position top       # Status bar at top
set -g detach-on-destroy off     # Don't exit tmux when closing a session
setw -g mode-keys vi             # Vi keys in copy mode

# Intuitive split bindings (keep current path)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# Vi copy mode: v to start selection, y to yank (clipboard via OSC 52)
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-pipe-and-cancel

# ── Prompt Navigation (OSC 133) ──────────────────────────────────
# Ctrl+Shift+Up/Down jumps between shell prompts inside tmux.
# Requires shell integration (OSC 133 sequences) — Ghostty's script
# is manually sourced in bashrc when inside tmux.
#
# Outside tmux, use Cmd+Shift+Up/Down (Ghostty native jump_to_prompt).
# See also: terminal/ghostty/config "Prompt navigation" section.
bind -n C-S-Up copy-mode \; send-keys -X previous-prompt
bind -n C-S-Down copy-mode \; send-keys -X next-prompt


# ── Mouse ───────────────────────────────────────────────────────────

set -g mouse on

# Drag windows on the status bar to reorder
bind -n MouseDrag1Status swap-window -d -t=

# Scroll wheel enters copy mode
bind -n WheelUpPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" \
    "if -Ft= '#{pane_in_mode}' 'send-keys -M' 'select-pane -t=; copy-mode -e; send-keys -M'"
bind -n WheelDownPane select-pane -t= \; send-keys -M

# Mouse selection copies to system clipboard without jumping to bottom (OSC 52)
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe


# ── Catppuccin v2 Theme ─────────────────────────────────────────────

set -g @catppuccin_flavor "mocha"
set -g @catppuccin_window_status_style "rounded"

# Window tabs: show window name (#W) not pane title (#T)
set -g @catppuccin_window_text " #W"
set -g @catppuccin_window_current_text " #W"

# ── Catppuccin v2 (source directly for guaranteed load order) ───────

# Use source-file (synchronous tmux config parsing) instead of
# run-shell (async shell execution). This ensures theme variables
# exist before we reference them.
source-file ~/.tmux/plugins/tmux/catppuccin_options_tmux.conf
source-file ~/.tmux/plugins/tmux/catppuccin_tmux.conf


# ── Plugins (TPM) ──────────────────────────────────────────────────
# Uses @tpm_plugins syntax instead of individual 'set -g @plugin' lines.
# This is required for TPM to work with custom config files (tmux -f).
# See: ~/.tmux/plugins/tpm/docs/tpm_not_working.md

set -g @tpm_plugins '           \
  tmux-plugins/tpm              \
  tmux-plugins/tmux-yank        \
  tmux-plugins/tmux-resurrect   \
'
set -g @resurrect-strategy-nvim 'session'

run '~/.tmux/plugins/tpm/tpm'


# ── Status Bar (MUST be after everything) ───────────────────────────

# Session on right, nothing on left.
# This goes last because TPM/sensible can override status-left/right.
set -g status-left ""
set -g status-right-length 55
set -g status-right "#{E:@catppuccin_status_session}"
