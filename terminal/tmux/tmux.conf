# tmux.260205-NEW.conf
# Fresh tmux config for Ghostty terminal with catppuccin v2
#
# Test with: tmux -L test -f <path-to-this-file> new-session


# ── Terminal & Ghostty ──────────────────────────────────────────────

# tmux advertises tmux-256color to programs inside it.
# xterm-ghostty is the *outer* terminal — we tell tmux its capabilities
# via terminal-features rather than setting it as default-terminal.
set -g default-terminal "tmux-256color"

# Tell tmux that xterm-ghostty supports true color and extended keys.
# Note: uses -s (not -as) to avoid duplicates when re-sourcing config.
# The defaults (xterm*:clipboard:ccolour:cstyle:focus:title, etc.) are
# built-in to tmux and don't need to be in this list.
set -s terminal-features 'xterm-ghostty:RGB:extkeys'

# Enable extended keys (kitty keyboard protocol / CSI u)
set -s extended-keys on
set -s extended-keys-format csi-u

# Allow escape sequences (e.g. OSC 133 for shell integration) to pass
# through tmux to the outer terminal (Ghostty).
set -g allow-passthrough on


# ── SSH Environment Propagation ─────────────────────────────────────

# Ghostty's ssh-env sends these to remote hosts. tmux doesn't include
# them in update-environment by default, so add them so new panes/
# windows pick them up when reattaching from a different terminal.
# Reset to defaults + Ghostty vars (avoids duplicates on re-source)
set -g update-environment "DISPLAY KRB5CCNAME SSH_ASKPASS SSH_AUTH_SOCK SSH_AGENT_PID SSH_CONNECTION WINDOWID XAUTHORITY TERM_PROGRAM TERM_PROGRAM_VERSION COLORTERM"


# ── Core Settings ───────────────────────────────────────────────────

set -g prefix C-a                # Ctrl-A prefix (not Ctrl-B)
unbind C-b                       # Free up default prefix
bind C-a send-prefix             # Send Ctrl-A to apps with prefix prefix

set -g base-index 1              # Windows start at 1
setw -g pane-base-index 1        # Panes start at 1
set -g renumber-windows on       # Renumber when a window is closed
set -g escape-time 0             # No delay after escape key
set -g history-limit 1000000     # Generous scrollback
set -g set-clipboard on          # Use system clipboard (OSC 52)
set -g status-position top       # Status bar at top
set -g detach-on-destroy off     # Don't exit tmux when closing a session
setw -g mode-keys vi             # Vi keys in copy mode

# Intuitive split bindings (keep current path)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# Vi copy mode: v to start selection, y to yank (clipboard via OSC 52)
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-pipe-and-cancel

# ── Prompt Navigation (OSC 133) ──────────────────────────────────
# Ctrl+Shift+Up/Down jumps between shell prompts inside tmux.
# Requires shell integration (OSC 133 sequences) — Ghostty's script
# is manually sourced in bashrc when inside tmux.
#
# Outside tmux, use Cmd+Shift+Up/Down (Ghostty native jump_to_prompt).
# See also: terminal/ghostty/config "Prompt navigation" section.
bind -n C-S-Up copy-mode \; send-keys -X previous-prompt
bind -n C-S-Down copy-mode \; send-keys -X next-prompt


# ── Mouse ───────────────────────────────────────────────────────────

set -g mouse on

# Drag windows on the status bar to reorder
# Uses MouseDragEnd + run-shell because swap-window -t= doesn't resolve
# the mouse target properly in a direct binding.
bind -n MouseDragEnd1Status run-shell 'tmux swap-window -d -t #{window_index}'

# Scroll wheel enters copy mode
bind -n WheelUpPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" \
    "if -Ft= '#{pane_in_mode}' 'send-keys -M' 'select-pane -t=; copy-mode -e; send-keys -M'"
bind -n WheelDownPane select-pane -t= \; send-keys -M

# Mouse selection copies to system clipboard without jumping to bottom (OSC 52)
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe


# ── From tmux-sensible (tmux-plugins/tmux-sensible) ──────────────────

# Status bar messages disappear after 750ms by default — too fast to read.
# Bumps to 4 seconds. Dismiss early with any keypress.
set -g display-time 4000

# Tmux redraws the status bar every 15 seconds by default. If your status
# bar shows time, git branch, etc., that means stale info. Drops to 5s.
set -g status-interval 5

# When you click into or away from your terminal window, the terminal
# emitter sends "focus in" / "focus out" escape sequences. By default,
# tmux eats these and doesn't pass them to programs inside. With this on,
# tmux forwards them.
# Why it matters:
#   - Vim/Neovim use focus events to auto-reload files that changed on
#     disk (:checktime fires on FocusGained)
#   - Ghostty sends these events, so turning this on means neovim inside
#     tmux inside Ghostty will properly detect when you tab back to it
# Without this, neovim won't know you switched back to the terminal, and
# you'd need to manually :checktime or move the cursor to trigger a reload.
set -g focus-events on

# When multiple clients attach to one session, tmux shrinks all windows to
# the smallest client — even windows only one client is viewing. This makes
# tmux only constrain a window based on clients actually looking at it.
setw -g aggressive-resize on

# Emacs key bindings in tmux command prompt (prefix + :) are better than
# vi keys, even for vim users
set -g status-keys emacs

# Quick window switching: prefix + Ctrl-p/n (in addition to default p/n).
# Lets you hold Ctrl the whole time — C-a C-p is faster than lifting
# Ctrl between C-a and p.
bind C-p previous-window
bind C-n next-window

# Prefix + Shift-R reloads tmux config. Without this you'd have to type
# :source-file ~/.tmux.conf in the command prompt.
bind R source-file '~/.tmux.conf'

# C-a a (prefix then just a) jumps to the last window you were in — a
# quick toggle. This mimics GNU Screen's behavior where C-a C-a toggled
# windows. Here the roles are split: C-a C-a sends a literal Ctrl-A to
# the program inside (via send-prefix, already in your config above),
# and C-a a toggles windows.
bind a last-window


# ── Catppuccin v2 Theme ─────────────────────────────────────────────

set -g @catppuccin_flavor "mocha"
set -g @catppuccin_window_status_style "rounded"

# Window tabs: show window name (#W) not pane title (#T)
set -g @catppuccin_window_text " #W"
set -g @catppuccin_window_current_text " #W"

# ── Catppuccin v2 (source directly for guaranteed load order) ───────

# Use source-file (synchronous tmux config parsing) instead of
# run-shell (async shell execution). This ensures theme variables
# exist before we reference them.
source-file ~/.tmux/plugins/tmux/catppuccin_options_tmux.conf
source-file ~/.tmux/plugins/tmux/catppuccin_tmux.conf


# ── Plugins (TPM) ──────────────────────────────────────────────────
# Uses @tpm_plugins syntax instead of individual 'set -g @plugin' lines.
# This is required for TPM to work with custom config files (tmux -f).
# See: ~/.tmux/plugins/tpm/docs/tpm_not_working.md

set -g @tpm_plugins '           \
  tmux-plugins/tpm              \
  tmux-plugins/tmux-resurrect   \
'
set -g @resurrect-strategy-nvim 'session'

run '~/.tmux/plugins/tpm/tpm'


# ── Status Bar (MUST be after everything) ───────────────────────────

# Session on right, nothing on left.
# This goes last because TPM/sensible can override status-left/right.
set -g status-left ""
set -g status-right-length 55
set -g status-right "#{E:@catppuccin_status_session}"
